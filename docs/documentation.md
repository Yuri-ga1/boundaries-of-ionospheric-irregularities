# Backend Documentation

## Структура папок и файлов

### Корневая директория
- **main.py** - основной файл запуска приложения

### app/processors/
- **map_processor.py** - содержит класс MapProcessor для обработки карт ROTI и поиска границ аврорального овала
- **rinex_processor.py** - содержит класс RinexProcessor для обработки RINEX файлов

### app/
- **az_el_to_lot_lon.py** - содержит функцию az_el_to_lat_lon для преобразования координат
- **png_to_video_converter.py** - содержит класс PngToVideoConverter для преобразования PNG изображений в видео

### debug_code/
- **plot_graphs.py** - содержит функции для построения графиков и визуализации данных
- **calc_sat_trajectory.py** - содержит класс Trajectory для расчета траекторий спутников

## Детальная документация файлов

### main.py

#### Функции

##### `generate_5min_timestamps(flyby_ts)`
**Назначение:** Создает список временных меток с 5-минутным интервалом для построения графиков

**Входные данные:**
- `flyby_ts` (list): Список временных меток в формате timestamp/float

**Результат:**
- `list`: Список строк времени в формате "%Y-%m-%d %H:%M:%S.%f"

---

##### `check_satellite_crossing(borders, satellites, threshold=10800)`
**Назначение:** Определяет моменты пересечения спутником границы, отмечая события "entered" или "exited"

**Входные данные:**
- `borders` (dict): Данные границ для каждой временной метки
- `satellites` (dict): Данные спутников с 'lon' и 'lat' для каждой временной метки
- `threshold` (int, опционально): Временной порог в секундах для группировки пересечений (по умолчанию 10800)

**Результат:**
- `dict`: Словарь со списками событий пересечения с временными метками и типами событий

---

##### `process_flyby(boundary, satellite_data, flybys, date_str)`
**Назначение:** Обрабатывает данные пролета спутников и сохраняет результаты в HDF5 файл

**Входные данные:**
- `boundary` (dict): Данные границ
- `satellite_data` (dict): Данные спутников
- `flybys` (dict): Данные пролетов
- `date_str` (str): Дата в формате строки для именования файлов

---

#### Основной блок выполнения

**Конфигурация:**
Используемые константы из config.py:
- `LON_CONDITION`, `LAT_CONDITION` - условия по долготе/широте
- `SEGMENT_LON_STEP`, `SEGMENT_LAT_STEP` - шаги сегментации
- `BOUNDARY_CONDITION` - условие границы
- `PROCESSED_FLYBYS_PATH`, `FILES_PATH`, `MAP_PATH`, `BOUNDARY_PATH`, `FLYBYS_PATH` - пути к файлам

**Процесс обработки:**
1. Инициализация MapProcessor с параметрами конфигурации
2. Обработка всех HDF5 файлов из директории FILES_PATH при помощи RinexProcessor
3. Создание файла карт и границ через MapProcessor
4. Анализ пересечений спутниками границ
5. Сохранение результатов в HDF5 формате
6. Визуализация результатов через plot_combined_graphs

---

### map_processor.py

#### Класс `MapProcessor`

**Назначение:** Класс для обработки картографических данных, включая фильтрацию точек по региону, скользящее окно, выделение границ овала и кластеризацию


**Конструктор:**
```python
__init__(lon_condition, lat_condition, segment_lon_step, segment_lat_step, boundary_condition)
```

**Входные данные:**
- `lon_condition` (float): ограничение по долготе для близости к полюсу
- `lat_condition` (float): ограничение по широте для близости к северному полюсу
- `segment_lon_step` (float): шаг скользящего окна по долготе
- `segment_lat_step` (float): шаг скользящего окна по широте
- `boundary_condition` (float): условие для определения границы

---

#### Методы класса MapProcessor

##### `process(map_path, output_path, time_points=None)`
**Назначение:** Основной метод обработки картографического файла

**Входные данные:**
- `map_path` (str): путь к входному HDF5 файлу карт
- `output_path` (str): путь к выходному HDF5 файлу
- `time_points` (list/None): конкретные временные точки для обработки

**Результат:** Создает выходной HDF5 файл со структурой:
- `points` - исходные данные
- `filtered_points` - отфильтрованные данные
- `sliding_windows` - регулярная сетка полученная скользящим окном
- `boundary` - данные сырой границы
- `boundary_clusters` - кластеризованные границы

---

##### `__filter_points(points_group)`
**Назначение:** Фильтрация точек по долготе и широте

**Входные данные:**
- `points_group` (h5py.Group): группа HDF5 с данными точек

**Результат:**
- `dict`: словарь с отфильтрованными 'lon', 'lat', 'vals'

---

##### `__apply_sliding_window(filtered_points, window_size=(5, 10))`
**Назначение:** Применение скользящего окна для перевода нерегулярной сетки в регулярную

**Входные данные:**
- `filtered_points` (dict): отфильтрованные точки с 'lon', 'lat', 'vals'
- `window_size` (tuple): размер окна (широта, долгота)

**Результат:**
- `list`: список точек регулярной сетки в формате {'lon', 'lat', 'vals'}

---

##### `__get_boundary_data(sliding_windows)`
**Назначение:** Построение точек границы через интерполяцию и контуры

**Входные данные:**
- `sliding_windows` (list): данные сегментов скользящего окна

**Результат:**
- `dict`: словарь с 'lat' и 'lon' точками границы

---

##### `__create_boundary_clusters(lat_list, lon_list, min_cluster_size=MIN_CLUSTER_SIZE)`
**Назначение:** Кластеризация граничных данных с использованием DBSCAN

**Входные данные:**
- `lat_list` (list): список широт границы
- `lon_list` (list): список долгот границы
- `min_cluster_size` (int): минимальный размер кластера

**Результат:**
- `dict/None`: словарь с кластеризованными границами или None если кластеры не найдены

**Структура результата:**
- `relation` - тип отношения кластеров ("single-cluster", "left-right", "top-bottom")
- `border1`, `border2` - кластеризованные границы

---

##### `__delete_circle(data, condition)`
**Назначение:**  Метод предназначен для удаления точек, образующих круговую структуру после достижения экстремальных значений.

**Входные данные:**
- `data` (numpy.array): данные кластера границы
- `condition` (float): условие фильтрации

**Результат:**
- `numpy.array`: отфильтрованные точки кластера

---

### rinex_processor.py

#### Класс `RinexProcessor`

**Назначение:** Класс для обработки RINEX файлов, преобразования координат и разделения данных на пролеты спутников

**Конструктор:**
```python
__init__(file_path)
```

**Входные данные:**
- `file_path` (str): путь к HDF5 файлу с данными RINEX

**Атрибуты:**
- `file_path` - путь к файлу
- `filename` - имя файла
- `lon_condition`, `lat_condition` - географические условия
- `stations_coords` - координаты станций
- `data` - обработанные данные
- `flybys` - данные пролетов спутников

---

#### Методы класса RinexProcessor

##### Контекстный менеджер
```python
__enter__() -> self
__exit__(exc_type, exc_value, traceback) -> None
```
**Назначение:** Обеспечение корректного открытия и закрытия HDF5 файла

---

##### `process(map_name)`
**Назначение:** Основной метод обработки RINEX данных

**Входные данные:**
- `map_name` (str): имя выходного файла

**Результат:** Создает два HDF5 файла:
- Файл карты в `MAP_PATH`
- Файл пролетов в `FLYBYS_PATH`

**Процесс обработки:**
1. Сохранение координат станций
2. Обработка данных каждого спутника
3. Преобразование азимута/угла места в широту/долготу
4. Разделение на пролеты
5. Фильтрация по углу места и географическим условиям
6. Сохранение в HDF5 формате

---

##### `restor_data(flyby_path)`
**Назначение:** Восстановление данных из ранее сохраненного HDF5 файла

**Входные данные:**
- `flyby_path` (str): путь к файлу с данными пролетов

**Результат:** Заполняет атрибуты `data` и `flybys` восстановленными данными

---

##### `sort_dict(d)`
**Назначение:** Рекурсивная сортировка вложенных словарей по ключам

**Входные данные:**
- `d` (dict): словарь для сортировки

**Результат:**
- `OrderedDict`: отсортированный словарь

---

#### Приватные методы

##### `__save_station_coords(station_name)`
**Назначение:** Сохранение координат станции при выполнении условий

**Входные данные:**
- `station_name` (str): имя станции

---

##### `__divide_by_flyby(station_name, satellite_name, roti, ts, lat, lon)`
**Назначение:** Разделение данных на отдельные пролеты спутников

**Входные данные:**
- `station_name` (str): имя станции
- `satellite_name` (str): имя спутника
- `roti` (array): значения ROTI
- `ts` (array): временные метки
- `lat` (array): широты
- `lon` (array): долготы

**Критерий разделения:** Разрыв во времени ≥ 1800 секунд

---

##### `__process_satellite(station_name, satellite_name)`
**Назначение:** Обработка данных отдельного спутника

**Входные данные:**
- `station_name` (str): имя станции
- `satellite_name` (str): имя спутника

**Результат:**
- `dict`: отфильтрованные данные с 'vals', 'lat', 'lon', 'timestamp'

**Фильтрация:**
- Угол места ≥ 10°
- Географические ограничения
- Временные метки кратные 300 секундам

---

##### `__create_h5(map_path, flyby_path)`
**Назначение:** Создание HDF5 файлов с обработанными данными

**Входные данные:**
- `map_path` (str): путь для файла карты
- `flyby_path` (str): путь для файла пролетов

**Структура файлов:**
- **map_file**: `data/{timestamp}/lon,lat,vals`
- **flyby_file**: `processed_data/{timestamp}/{station}/lon,lat,vals` и `flybys/{station}/{satellite}/{flyby}/roti,timestamps,lat,lon`

---

### az_el_to_lot_lon.py

#### Функция `az_el_to_lat_lon(s_lat, s_lon, az, el, hm=HM, R=RE_KM)`

**Назначение:** Вычисление точки подспутниковой точки (subionospheric point) и дельт от местоположения станции

**Входные данные:**
- `s_lat` (float): широта станции в радианах
- `s_lon` (float): долгота станции в радианах
- `az` (float): азимут линии визирования станция-спутник в радианах
- `el` (float): угол места линии визирования станция-спутник в радианах
- `hm` (float, опционально): высота ионосферного максимума в км (по умолчанию HM)
- `R` (float, опционально): радиус Земли в км (по умолчанию RE_KM)

**Результат:**
- `tuple`: (lat, lon) - широта и долгота подспутниковой точки в радианах

**Математическая основа:**
- Использует сферическую геометрию для преобразования координат
- Учитывает кривизну Земли и высоту ионосферы
- Корректирует долготу для сохранения в диапазоне [-π, π]

---

### png_to_video_converter.py

#### Класс `PngToVideoConverter`

**Назначение:** Класс для преобразования PNG изображений в видеофайлы

**Конструктор:**
```python
__init__(input_dir, output_dir, fps=16)
```

**Входные данные:**
- `input_dir` (str): путь к корневой директории, содержащей PNG файлы
- `output_dir` (str): путь к директории для сохранения видеофайлов
- `fps` (int, опционально): кадров в секунду для генерируемого видео (по умолчанию 16)

**Атрибуты:**
- `input_dir` - входная директория с PNG файлами
- `output_dir` - выходная директория для видео
- `fps` - частота кадров

---

#### Методы класса PngToVideoConverter

##### `find_all_png_folders()`
**Назначение:** Рекурсивный поиск всех папок, содержащих PNG файлы

**Результат:**
- `list`: список путей к директориям, содержащим PNG изображения

**Алгоритм:**
- Рекурсивно обходит дерево директорий начиная с `input_dir`
- Проверяет наличие файлов с расширением `.png` в каждой директории

---

##### `create_video_from_images(image_files, output_path)`
**Назначение:** Создание видео из списка файлов изображений

**Входные данные:**
- `image_files` (list): список путей к PNG изображениям для компиляции в видео
- `output_path` (str): путь для сохранения сгенерированного видео

**Процесс:**
1. Создает необходимые директории для выходного файла
2. Использует imageio для создания видео с кодеком libx264
3. Последовательно добавляет изображения в видео
4. Обрабатывает ошибки чтения отдельных файлов

**Технические детали:**
- Формат видео: MP4 с кодеком H.264 (libx264)
- Автоматическая сортировка файлов изображений

---

##### `process_images_to_video()`
**Назначение:** Основной метод обработки - находит все папки с PNG файлами и создает видео для каждой папки

**Процесс обработки:**
1. Находит все папки с PNG файлами через `find_all_png_folders()`
2. Для каждой папки:
   - Собирает все PNG файлы
   - Создает структуру выходных путей на основе относительного пути
   - Формирует имя видеофайла из частей пути
   - Вызывает `create_video_from_images()` для создания видео

**Структура именования:**
- Выходные видео сохраняются в поддиректориях, соответствующих первой части пути
- Имя видео формируется из оставшихся частей пути, объединенных через "_"

---

### plot_graphs.py

#### Функции визуализации

##### `remove_traj_lines(trajectory_elements)`
**Назначение:** Удаление элементов траектории с графиков

**Входные данные:**
- `trajectory_elements` (list): список элементов траектории для удаления

---

##### `plot_clusters(cluster_dict, time_point)`
**Назначение:** Визуализация кластеров на карте

**Входные данные:**
- `cluster_dict` (dict): словарь с данными кластеров
- `time_point` (str): временная метка для заголовка

---

##### `compute_polygons(boundary_clusters, time_point)`
**Назначение:** Вычисление полигонов и их пересечений на основе кластеров границ

**Входные данные:**
- `boundary_clusters` (dict): данные кластеров границ
- `time_point` (str): временная метка

**Результат:**
- `tuple`: (polygons, intersection, single_cluster_polygon) - полигоны, пересечение и одиночный кластер

---

##### `plot_polygon(boundary_clusters, time_point, ax=None)`
**Назначение:** Визуализация полигонов границ

**Входные данные:**
- `boundary_clusters` (dict): данные кластеров границ
- `time_point` (str): временная метка
- `ax` (matplotlib.axes): ось для отрисовки (опционально)

**Результат:**
- `tuple`: (fig, ax) - объекты figure и axes

---

##### `plot_roti_map(roti_points, time_point, ax=None, cmap='coolwarm')`
**Назначение:** Визуализация карты ROTI

**Входные данные:**
- `roti_points` (dict): точки ROTI с 'lon', 'lat', 'vals'
- `time_point` (str): временная метка
- `ax` (matplotlib.axes): ось для отрисовки (опционально)
- `cmap` (str): цветовая карта

**Результат:**
- `tuple`: (fig, ax) - объекты figure и axes

---

##### `plot_sliding_window(sliding_windows, boundary_data, boundary_condition, ax=None, time_point=None, cmap='coolwarm')`
**Назначение:** Визуализация скользящего окна с граничными данными

**Входные данные:**
- `sliding_windows` (list): данные скользящего окна
- `boundary_data` (dict): граничные точки
- `boundary_condition` (str): тип условия границы
- `ax` (matplotlib.axes): ось для отрисовки (опционально)
- `time_point` (str): временная метка (опционально)
- `cmap` (str): цветовая карта

**Результат:**
- `tuple`: (fig, ax) - объекты figure и axes

---

##### `plot_roti_dynamics(station_data, satellite, time_point=None, ax=None)`
**Назначение:** Визуализация динамики ROTI для пары станция-спутник

**Входные данные:**
- `station_data` (dict): данные станции
- `satellite` (str): идентификатор спутника
- `time_point` (str): временная метка (опционально)
- `ax` (matplotlib.axes): ось для отрисовки (опционально)

**Результат:**
- `tuple`: (fig, ax) - объекты figure и axes

---

##### `add_sat_traj(station_lat, station_lon, sat_azs, sat_els, sat_times, time_point, ax_list=None)`
**Назначение:** Добавление траектории спутника на графики

**Входные данные:**
- `station_lat` (float): широта станции
- `station_lon` (float): долгота станции
- `sat_azs` (array): азимуты спутника
- `sat_els` (array): углы места спутника
- `sat_times` (array): временные метки спутника
- `time_point` (str): временная метка
- `ax_list` (list): список осей для отрисовки

**Результат:**
- `list`: элементы траектории

---

##### `clean_events(event_times, event_types)`
**Назначение:** Очистка и группировка событий пересечения

**Входные данные:**
- `event_times` (list): времена событий
- `event_types` (list): типы событий

**Результат:**
- `tuple`: (cleaned_times, cleaned_types) - очищенные времена и типы

---

##### `plot_flyby(roti, times, station, satellite, cleaned_times, cleaned_types, time_point=None, ax=None)`
**Назначение:** Визуализация пролета спутника с событиями пересечения

**Входные данные:**
- `roti` (array): значения ROTI
- `times` (array): временные метки
- `station` (str): идентификатор станции
- `satellite` (str): идентификатор спутника
- `cleaned_times` (list): очищенные времена событий
- `cleaned_types` (list): очищенные типы событий
- `time_point` (str): временная метка (опционально)
- `ax` (matplotlib.axes): ось для отрисовки (опционально)

**Результат:**
- `tuple`: (fig, ax) - объекты figure и axes

---

##### `plot_combined_graphs(...)`
**Назначение:** Генерация комплексной визуализации, объединяющей multiple графиков

**Входные данные:**
- `map_points` (dict): данные карты ROTI
- `sliding_windows` (list): сегменты данных скользящего окна
- `boundary_data` (dict): граничные точки
- `boundary_condition` (str): условие границы
- `time_point` (str): временная метка
- `boundary_clusters` (dict): кластеры границ
- `roti_file` (str): путь к HDF5 файлу ROTI
- `flyby_idx` (str): индекс пролета
- `flyby_roti` (array): ROTI пролета
- `flyby_times` (array): времена пролета
- `flyby_events_times` (list): времена событий пролета
- `flyby_events_types` (list): типы событий пролета
- `station` (str): станция
- `satellite` (str): спутник
- `save_to_file` (bool): флаг сохранения в файл

**Результат:**
- Создает комбинированный график с 4 панелями:
  1. Карта ROTI
  2. Скользящее окно с границами
  3. Полигоны границ
  4. Динамика пролета с событиями

---

### calc_sat_trajectory.py

#### Класс `Trajectory`

**Назначение:** Класс для расчета и обработки траекторий спутников на основе данных азимута и угла места

**Конструктор:**
```python
__init__(lat_site, lon_site)
```

**Входные данные:**
- `lat_site` (float): широта станции в градусах
- `lon_site` (float): долгота станции в градусах

**Атрибуты:**
- `lat_site` - широта станции
- `lon_site` - долгота станции
- `traj_lat` - список широт траектории
- `traj_lon` - список долгот траектории
- `times` - список временных меток

---

#### Методы класса Trajectory

##### `filter_points()`
**Назначение:** Фильтрация точек траектории по географическим условиям

**Фильтрация:**
- Долгота между -120 и LON_CONDITION
- Широта ≥ LAT_CONDITION

**Результат:** Обновляет атрибуты traj_lat, traj_lon, times с отфильтрованными данными

---

##### `adding_artificial_value(minutes=10)`
**Назначение:** Добавление искусственных точек в траекторию для заполнения больших временных промежутков

**Входные данные:**
- `minutes` (int): интервал в минутах для определения больших промежутков (по умолчанию 10)

**Процесс:**
1. Определяет промежутки больше указанного интервала
2. Добавляет три искусственные точки в середине каждого промежутка
3. Временные метки искусственных точек: -30сек, 0сек, +30сек от середины промежутка
4. Координаты искусственных точек устанавливаются в None

---

##### `procces(azs, els, times)`
**Назначение:** Основной метод обработки данных траектории

**Входные данные:**
- `azs` (array): азимуты спутника в радианах
- `els` (array): углы места спутника в радианах
- `times` (array): временные метки

**Процесс обработки:**
1. Преобразование азимута/угла места в широту/долготу через az_el_to_lat_lon
2. Конвертация координат из радиан в градусы
3. Фильтрация точек по географическим условиям
4. Добавление искусственных точек для больших промежутков
5. Проверка целостности данных (assert)

**Результат:** Заполняет атрибуты traj_lat, traj_lon, times обработанными данными

---

## Используемые константы из config.py

### Основные константы:
- `LON_CONDITION`, `LAT_CONDITION` - географические условия
- `SEGMENT_LON_STEP`, `SEGMENT_LAT_STEP` - шаги сегментации
- `BOUNDARY_CONDITION` - условие границы
- `MIN_CLUSTER_SIZE`, `WINDOW_AREA`, `WINDOW_WIDTH` - параметры обработки
- `HM`, `RE_KM` - параметры преобразования координат
- `TIME_GAP_LIMIT` - временной лимит для группировки событий

### Пути к файлам:
- `PROCESSED_FLYBYS_PATH`, `FILES_PATH`, `MAP_PATH`, `BOUNDARY_PATH`, `FLYBYS_PATH`
- `FRAME_GRAPHS_PATH` - путь для сохранения графиков

### Логирование:
- `logger` - объект для логирования

## Взаимосвязи между компонентами

### Основной поток выполнения (main.py):
1. **RinexProcessor** обрабатывает RINEX файлы
2. **MapProcessor** создает карты и границы
3. Функции анализа пересечений обрабатывают данные
4. **plot_combined_graphs** создает визуализации с использованием **Trajectory**
5. **PngToVideoConverter** используется дляконвертации сгенерированных PNG графиков в видео

### Преобразование координат:
- **RinexProcessor** и **Trajectory** используют **az_el_to_lat_lon** для преобразования азимута/угла места в широту/долготу

### Визуализация:
- Все функции из **plot_graphs.py** используются для создания графиков и анализа данных
- **plot_combined_graphs** объединяет multiple визуализации в один комплексный график
- **Trajectory** используется в **add_sat_traj** для расчета и отображения траекторий спутников
- **PngToVideoConverter** преобразует сгенерированные PNG изображения в видеофайлы

### Хранение данных:
- Все компоненты используют HDF5 формат для хранения промежуточных и конечных результатов
